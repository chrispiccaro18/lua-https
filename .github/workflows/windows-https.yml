name: Build https.dll (Windows, LuaJIT where supported)

on:
  workflow_dispatch:
  push:
    branches: [ main, ci-* ]
  pull_request:

permissions:
  contents: read

jobs:
  build-windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, Win32, ARM64]   # MSVC architectures

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install vcpkg + Lua/LuaJIT
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          if ("${{ matrix.arch }}" -eq "Win32") { $triplet = "x86-windows" }
          elseif ("${{ matrix.arch }}" -eq "ARM64") { $triplet = "arm64-windows" }
          else { $triplet = "x64-windows" }

          git clone https://github.com/microsoft/vcpkg $env:USERPROFILE\vcpkg
          & $env:USERPROFILE\vcpkg\bootstrap-vcpkg.bat

          # Lua flavor per-arch: use LuaJIT where supported, Lua on ARM64
          if ($triplet -eq "arm64-windows") {
            & $env:USERPROFILE\vcpkg\vcpkg.exe install lua --triplet $triplet --clean-after-build
            $luaFlavor = "lua"
          } else {
            & $env:USERPROFILE\vcpkg\vcpkg.exe install luajit --triplet $triplet --clean-after-build
            $luaFlavor = "luajit"
          }

          "VCPKG_ROOT=$($env:USERPROFILE)\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Append
          "VCPKG_TRIPLET=$triplet" | Out-File -FilePath $env:GITHUB_ENV -Append
          "BT_LUA_FLAVOR=$luaFlavor" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure (CMake)
        shell: pwsh
        run: >
          cmake -B build -S .
          -A ${{ matrix.arch }}
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET="$env:VCPKG_TRIPLET"
          -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}\install"

      - name: Build & Install (Release)
        run: cmake --build build --config Release --target install
        shell: pwsh

      - name: Show install tree (debug)
        shell: pwsh
        run: |
          Write-Host "`n=== Installed files ==="
          Get-ChildItem -Recurse install | ForEach-Object { $_.FullName }

      - name: Upload DLL artifact
        uses: actions/upload-artifact@v4
        with:
          name: https-${{ matrix.arch }}-${{ env.BT_LUA_FLAVOR }}
          path: |
            install\**\*.dll
            install\**\*.pdb
            install\**\*.lib
            install\**\*.exp
          if-no-files-found: error
